---
# Custom CIS Benchmark Hardening Playbook
# Generated from 5 selected rules
#
# Rules: 5.1.1, 5.1.2, 5.1.3, 5.1.4, 5.1.5

- name: Custom CIS Benchmark Hardening
  hosts: "{{ target_hosts | default('all') }}"
  become: true
  gather_facts: true

  vars:
    cis_apply_remediation: true
    cis_report_dir: /tmp/cis_custom_report

  pre_tasks:
    - name: Create report directory
      file:
        path: "{{ cis_report_dir }}"
        state: directory
        mode: "0755"

    - name: Display start message
      debug:
        msg: "Starting CIS hardening for 5 selected rules"

  tasks:

    # ===== Rule 1/5: 5.1.1 =====

    - name: "[1/5] Check 5.1.1: Check permissions on /etc/ssh/sshd_config"
      shell: |
        # Check permissions on /etc/ssh/sshd_config
        actual=$(stat -Lc "%a %u %g" /etc/ssh/sshd_config 2>/dev/null)
        
        if [ "$actual" = "600 0 0" ]; then
            echo "PASS: /etc/ssh/sshd_config has correct permissions (600 0 0)"
            exit 0
        else
            echo "FAIL: /etc/ssh/sshd_config has incorrect permissions"
            echo "  Expected: 600 0 0"
            echo "  Actual: $actual"
            exit 1
        fi
      register: audit_5_1_1
      failed_when: false
      changed_when: false
      check_mode: false

    - name: "[1/5] Remediate 5.1.1: Check permissions on /etc/ssh/sshd_config"
      shell: |
        # Remediate permissions on /etc/ssh/sshd_config
        echo "Setting permissions on /etc/ssh/sshd_config..."
        if [ -f /etc/ssh/sshd_config ]; then
            chown root:root /etc/ssh/sshd_config
            chmod 600 /etc/ssh/sshd_config
            echo "SUCCESS: Permissions set to 600, owner set to root:root"
        else
            echo "ERROR: /etc/ssh/sshd_config not found"
            exit 1
        fi
      when: audit_5_1_1.rc != 0 and cis_apply_remediation | bool
      register: remediate_5_1_1

    - name: "[1/5] Display result for 5.1.1"
      debug:
        msg: |
          Rule 5.1.1: {{ "PASS" if audit_5_1_1.rc == 0 else "FAIL -> REMEDIATED" if remediate_5_1_1 is defined and remediate_5_1_1.changed else "FAIL" }}


    # ===== Rule 2/5: 5.1.2 =====

    - name: "[2/5] Check 5.1.2: Check permissions on SSH private host key files"
      shell: |
        # Check permissions on SSH private host key files
        failed=0
        while IFS= read -r file; do
            actual=$(stat -Lc "%a %u %g" "$file" 2>/dev/null)
            if [ "$actual" != "600 0 0" ]; then
                echo "FAIL: $file has incorrect permissions"
                echo "  Expected: 600 0 0"
                echo "  Actual: $actual"
                failed=1
            fi
        done < <(find /etc/ssh -xdev -type f -name 'ssh_host_*_key' 2>/dev/null)
        
        if [ $failed -eq 0 ]; then
            echo "PASS: All SSH private host key files have correct permissions"
            exit 0
        else
            exit 1
        fi
      register: audit_5_1_2
      failed_when: false
      changed_when: false
      check_mode: false

    - name: "[2/5] Remediate 5.1.2: Check permissions on SSH private host key files"
      shell: |
        # Remediate permissions on SSH private host key files
        echo "Setting permissions on SSH private host key files..."
        find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chmod 600 {} \;
        find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chown root:root {} \;
        echo "SUCCESS: All SSH private host key files secured"
      when: audit_5_1_2.rc != 0 and cis_apply_remediation | bool
      register: remediate_5_1_2

    - name: "[2/5] Display result for 5.1.2"
      debug:
        msg: |
          Rule 5.1.2: {{ "PASS" if audit_5_1_2.rc == 0 else "FAIL -> REMEDIATED" if remediate_5_1_2 is defined and remediate_5_1_2.changed else "FAIL" }}


    # ===== Rule 3/5: 5.1.3 =====

    - name: "[3/5] Check 5.1.3: Check permissions on SSH public host key files"
      shell: |
        # Check permissions on SSH public host key files
        failed=0
        while IFS= read -r file; do
            actual=$(stat -Lc "%a %u %g" "$file" 2>/dev/null)
            perm=$(echo "$actual" | awk '{print $1}')
            owner=$(echo "$actual" | awk '{print $2}')
            group=$(echo "$actual" | awk '{print $3}')
            
            if [ "$owner" != "0" ] || [ "$group" != "0" ]; then
                echo "FAIL: $file has incorrect ownership"
                echo "  Expected owner:group: 0:0"
                echo "  Actual: $owner:$group"
                failed=1
            elif [ "$perm" -gt 644 ]; then
                echo "FAIL: $file has incorrect permissions"
                echo "  Expected: 644 or more restrictive"
                echo "  Actual: $perm"
                failed=1
            fi
        done < <(find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' 2>/dev/null)
        
        if [ $failed -eq 0 ]; then
            echo "PASS: All SSH public host key files have correct permissions"
            exit 0
        else
            exit 1
        fi
      register: audit_5_1_3
      failed_when: false
      changed_when: false
      check_mode: false

    - name: "[3/5] Remediate 5.1.3: Check permissions on SSH public host key files"
      shell: |
        # Remediate permissions on SSH public host key files
        echo "Setting permissions on SSH public host key files..."
        find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chmod 644 {} \;
        find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chown root:root {} \;
        echo "SUCCESS: All SSH public host key files secured"
      when: audit_5_1_3.rc != 0 and cis_apply_remediation | bool
      register: remediate_5_1_3

    - name: "[3/5] Display result for 5.1.3"
      debug:
        msg: |
          Rule 5.1.3: {{ "PASS" if audit_5_1_3.rc == 0 else "FAIL -> REMEDIATED" if remediate_5_1_3 is defined and remediate_5_1_3.changed else "FAIL" }}


    # ===== Rule 4/5: 5.1.4 =====

    - name: "[4/5] Check 5.1.4: Check if sshd access is configured"
      shell: |
        # Check if sshd access is configured
        result=$(sshd -T 2>/dev/null | grep -Pi -- '^\h*(allow|deny)(users|groups)\h+\H+')
        
        if [ -n "$result" ]; then
            echo "PASS: sshd access control is configured:"
            echo "$result"
            exit 0
        else
            echo "FAIL: No sshd access control configured"
            echo "  Configure at least one of: AllowUsers, AllowGroups, DenyUsers, or DenyGroups"
            exit 1
        fi
      register: audit_5_1_4
      failed_when: false
      changed_when: false
      check_mode: false

    - name: "[4/5] Remediate 5.1.4: Check if sshd access is configured"
      shell: |
        # Remediate sshd access configuration
        echo "Configuring sshd access control..."
        # Check if already configured
        if grep -qE '^\s*(AllowUsers|AllowGroups|DenyUsers|DenyGroups)\s+' /etc/ssh/sshd_config; then
            echo "INFO: SSH access control is already configured:"
            grep -E '^\s*(AllowUsers|AllowGroups|DenyUsers|DenyGroups)\s+' /etc/ssh/sshd_config
            echo "No changes made."
            exit 0
        fi
        # Remove any commented directives
        sed -i '/^#\s*AllowGroups/d' /etc/ssh/sshd_config
        # Add AllowGroups sudo (recommended approach)
        echo "AllowGroups sudo" >> /etc/ssh/sshd_config
        # Reload sshd
        systemctl reload sshd
        echo "SUCCESS: SSH access configured for sudo group members"
        echo "  AllowGroups sudo"
        echo "Note: Only users in the 'sudo' group can now access SSH."
        echo "To add a user to sudo group: usermod -aG sudo <username>"
      when: audit_5_1_4.rc != 0 and cis_apply_remediation | bool
      register: remediate_5_1_4

    - name: "[4/5] Display result for 5.1.4"
      debug:
        msg: |
          Rule 5.1.4: {{ "PASS" if audit_5_1_4.rc == 0 else "FAIL -> REMEDIATED" if remediate_5_1_4 is defined and remediate_5_1_4.changed else "FAIL" }}


    # ===== Rule 5/5: 5.1.5 =====

    - name: "[5/5] Check 5.1.5: Check if sshd Banner is configured"
      shell: |
        # Check if sshd Banner is configured
        result=$(sshd -T 2>/dev/null | grep -i '^banner')
        
        if echo "$result" | grep -q 'banner /'; then
            echo "PASS: sshd Banner is configured"
            echo "  $result"
            exit 0
        else
            echo "FAIL: sshd Banner is not configured"
            echo "  Expected: banner <path>"
            echo "  Actual: $result"
            exit 1
        fi
      register: audit_5_1_5
      failed_when: false
      changed_when: false
      check_mode: false

    - name: "[5/5] Remediate 5.1.5: Check if sshd Banner is configured"
      shell: |
        # Remediate sshd Banner configuration
        echo "Configuring sshd Banner..."
        # Remove any existing Banner directive
        sed -i '/^Banner\s/d' /etc/ssh/sshd_config
        # Add Banner directive
        echo "Banner /etc/issue.net" >> /etc/ssh/sshd_config
        # Reload sshd
        systemctl reload sshd
        echo "SUCCESS: Banner configured to /etc/issue.net"
      when: audit_5_1_5.rc != 0 and cis_apply_remediation | bool
      register: remediate_5_1_5

    - name: "[5/5] Display result for 5.1.5"
      debug:
        msg: |
          Rule 5.1.5: {{ "PASS" if audit_5_1_5.rc == 0 else "FAIL -> REMEDIATED" if remediate_5_1_5 is defined and remediate_5_1_5.changed else "FAIL" }}

  post_tasks:
    - name: Display completion message
      debug:
        msg: "CIS hardening completed for 5 rules"
